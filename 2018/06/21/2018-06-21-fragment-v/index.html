<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="keywords" content="hexo, autumn">
    <title>
        Life is Like A Boat
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/favicon.ico">
     <link rel="stylesheet" href="/css/style.css">

    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@2.0.0/dist/main.js"></script>

    <script>
        infiniteScroll()

        window.addEventListener('DOMContentLoaded', function () {
            const [
                mainTitle,
                mobileMenu,
                mobileMainTitle,
                mobileMenuBtn,
                ipadMenuBtn,
                aside,
                closeBtn,
            ] = getEle(
                '#main-title',
                '.mobile-menu',
                '.mobile-menu h3',
                '.mobile-menu button',
                '.ipad-menu',
                'aside',
                'aside .close',
            )
            const io = new IntersectionObserver(entries => {
                if (entries[0].intersectionRatio <= 0) {
                    mobileMainTitle.classList.remove('invisibile')
                } else {
                    mobileMainTitle.classList.add('invisibile')
                }
            })
            io.observe(mainTitle)

            clickToggleAside(mobileMenuBtn)
            clickToggleAside(ipadMenuBtn)
            clickToggleAside(closeBtn, false)

            const isMenuVisible = window.getComputedStyle(mobileMenu).display !== 'none'
            if (isMenuVisible) document.body.style.background = 'none'

            function getEle(...args) {
                return args.map(arg => document.querySelector(arg))
            }

            function clickToggleAside(btn, show = true) {
                btn.addEventListener('click', function () {
                    if (show) {
                        aside.style.display = 'block'
                    } else {
                        aside.style.display = 'none'
                    }
                })
            }
        })
    </script>
</head>

<body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
    <div class="container">
        <header class="header">
    <nav class="mobile-menu" style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <h3 class="invisibile">
            <a href="/" class="logo">
                Life is Like A Boat
            </a>
        </h3>
        <button class="menu">menu</button>
    </nav>

    <button class="ipad-menu menu">menu</button>

    <h1 class="title" id="main-title">
        <a href="/" class="logo">
            Life is Like A Boat
        </a>
    </h1>
    <h2 class="desc">
        Silent
    </h2>

    <div class="links">
        <ul>
            
            <li>
                <a href="https://github.com/FrontendSophie">
                    Github
                </a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/frontendsophie/">
                    LinkedIn
                </a>
            </li>
            
        </ul>
    </div>
</header>
        <main class="main">
            <article class="post">
    
    
    <h4 class="post-cat">
        <a href="/categories/Android/">
            Android
        </a>
    </h4>
    
    
    <h2 class="post-title">
        提供一种Fragment可见性改变的监测方案
    </h2>
    <ul class="post-date">
        <li>
            2018-06-21
        </li>
        <li>
            AiLo
        </li>
    </ul>
    <div class="post-content">
        <p><strong>原创文章，转载请联系作者</strong></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Fragment，这个让人又爱又恨“碎片”。<br>使用它可以让项目更加轻便–我们可以将功能分割、复用，但其复杂的生命周期和<code>Transaction事务</code>，在极端操作【某些测试人员有一手绝活，三指甚至六指同时触屏乱弹】下会出现一些不可预期的错误–<code>Fragment</code>嵌套<code>Fragment</code>,横竖屏切换等等。<br>但无论怎样，面对解决问题，才是关键。这篇文章就是针对<code>Fragment</code>监测可见状态改变，提供一种解决方案。</p>
<h3 id="Fragment可见性解析"><a href="#Fragment可见性解析" class="headerlink" title="Fragment可见性解析"></a>Fragment可见性解析</h3><p>首先，要说明一下，这里的可见性就是对用户来说看的见。不仅仅是界面位于顶层那种常规情况，而是即便界面上还存在一层透明界面或是对话框，那么依然判定其对用户可见，为<code>visible</code>。<br><strong>接下来会分析在特定交互环境下，Fragment内部被触发的方法。</strong></p>
<h4 id="onResume"><a href="#onResume" class="headerlink" title="onResume"></a>onResume</h4><p><code>Fragment</code>是不能单独存在的，它所在的视图树中，往下追溯，根部一定是一个<code>Activity</code>。在源码中，<code>onResume()</code>方法的描述很有意思。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Called when the fragment is visible to the user and actively running.</span><br><span class="line">     * This is generally</span><br><span class="line">     * tied to &#123;@link Activity#onResume() Activity.onResume&#125; of the containing</span><br><span class="line">     * Activity&apos;s lifecycle.</span><br><span class="line">     */</span><br><span class="line">    @CallSuper</span><br><span class="line">    public void onResume() &#123;</span><br><span class="line">        mCalled = true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一般情况下，对用户可见时触发。绑定在依赖的Activity生命周期里</p>
</blockquote>
<p>也就是说，一般这个方法，会在可见并且正在活跃时被调用。但说到底，还是个“窝里造”，生命周期完全依赖于<code>父容器</code>—-也一定依赖于<strong>根Activity</strong>。<br>那么不一般的情况下呢？<br>有这么一个例子，在进入一个<code>Activity</code>界面时，直接调用了<code>beginTransaction().hide(Fragment)</code>方法。那么用户一开始就不会看到这个界面，但生命周期确实也走到了<code>onResume</code>。由此可知，可见性的判断不能只依赖于这一个方法的判断。</p>
<h4 id="onHiddenChanged"><a href="#onHiddenChanged" class="headerlink" title="onHiddenChanged"></a>onHiddenChanged</h4><p>这个方法在使用<code>beginTransaction().hide(Fragment)</code>会被调用，而且是在<code>onResume</code>之前。<br>先来看看源码里的描述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* @param hidden True if the fragment is now hidden, false otherwise.</span><br><span class="line">    */</span><br><span class="line">   public void onHiddenChanged(boolean hidden) &#123;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个方法会回调出来一个参数，true的时候表示隐藏了，false表示可见。在可见性改变时被调用。<br>这里要注意一下这个布尔值的定义！</p>
</blockquote>
<h4 id="setUserVisibleHint"><a href="#setUserVisibleHint" class="headerlink" title="setUserVisibleHint"></a>setUserVisibleHint</h4><p>ViewPager搭配Fragment，也是常见的交互模式了。此时左右滑动时，这个方法会被触发。但有一点要说明一下，当ViewPager初始化时，Fragment相应的生命周期里。<code>setUserVisibleHint</code>方法是走在Fragment的<code>onCreate</code>之前的。</p>
<p><strong>以上几个方法，就是常见的交互下，会被触发的方法了。可见性的监测，主要也依赖于这个方法的相互配合。<br>这里还需要说明一下，可见性的监测，监测的是<em>“改变”</em>。也就是当Fragment被创建出来时，不会触发监测方法，不管它是可见还是不可见的状态。</strong></p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>在BaseFragment内，提供了一个<code>onVisibleToUserChanged(boolean isVisibleToUser)</code>方法作为内部回调。参数<code>isVisibleToUser</code>如字面所示，<strong>True</strong>表示可见，<strong>false</strong>不可见。当你需要在界面不可见，取消网络请求或是释放一些东西，你就可以使用此方案。<br>代码实现相当简单，就是一连串逻辑代码而已。只是在<code>onResume</code>方法里，需要判断一下是否已经触发了<code>onHiddenChanged</code>或是<code>setuserVisibleHint</code>方法。<br>代码很短，不到100行。这里直接贴出来。不方便的小可爱们，可以直接去<a href="https://github.com/JadynAi/KotlinDiary/blob/master/app/src/main/java/com/motong/cm/kotlintest/BaseFragment.kt" target="_blank" rel="noopener">GitHub地址</a>.如果你喜欢的话，不妨点个赞吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">abstract class BaseFragment : Fragment()&#123;</span><br><span class="line">    lateinit var mRootView: View</span><br><span class="line">    private var isVisibleToUsers = false</span><br><span class="line">    private var isOnCreateView = false</span><br><span class="line">    private var isSetUserVisibleHint = false</span><br><span class="line">    private var isHiddenChanged = false</span><br><span class="line">    private var isFirstResume = false</span><br><span class="line">    </span><br><span class="line">    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? &#123;</span><br><span class="line">        isOnCreateView = true</span><br><span class="line">        mRootView = LayoutInflater.from(activity).inflate(getResId(), null, false)</span><br><span class="line">        return mRootView</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abstract fun getResId(): Int</span><br><span class="line"></span><br><span class="line">    override fun onResume() &#123;</span><br><span class="line">        super.onResume()</span><br><span class="line">        if (!isHiddenChanged &amp;&amp; !isSetUserVisibleHint) &#123;</span><br><span class="line">            if (isFirstResume) &#123;</span><br><span class="line">                setVisibleToUser(true)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (isSetUserVisibleHint || (!isFirstResume &amp;&amp; !isHiddenChanged)) &#123;</span><br><span class="line">            isVisibleToUsers = true</span><br><span class="line">        &#125;</span><br><span class="line">        isFirstResume = true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onPause() &#123;</span><br><span class="line">        super.onPause()</span><br><span class="line">        isHiddenChanged = false</span><br><span class="line">        isSetUserVisibleHint = false</span><br><span class="line">        setVisibleToUser(false)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override fun setUserVisibleHint(isVisibleToUser: Boolean) &#123;</span><br><span class="line">        super.setUserVisibleHint(isVisibleToUser)</span><br><span class="line">        isSetUserVisibleHint = true</span><br><span class="line">        setVisibleToUser(isVisibleToUser)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onHiddenChanged(hidden: Boolean) &#123;</span><br><span class="line">        super.onHiddenChanged(hidden)</span><br><span class="line">        isHiddenChanged = true</span><br><span class="line">        setVisibleToUser(!hidden)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private fun setVisibleToUser(isVisibleToUser: Boolean) &#123;</span><br><span class="line">        if (!isOnCreateView) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if (isVisibleToUser == isVisibleToUsers) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        isVisibleToUsers = isVisibleToUser</span><br><span class="line">        onVisibleToUserChanged(isVisibleToUsers)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected open fun onVisibleToUserChanged(isVisibleToUser: Boolean) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上<br></p>

    </div>
</article>
        </main>
        <aside class="aside">
            <div class="close"></div>
            <section class="aside-section">
                
    <h1>Categories</h1>

    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频/">音视频</a></li></ul>

            </section>
            <section class="aside-section">
                
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a></li></ul>


            </section>
            <section class="aside-section tag">
                
    <h1>Tags</h1>

    <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Camera2/">Camera2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Canvas动画/">Canvas动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MediaCodeC/">MediaCodeC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenGL/">OpenGL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/交互体验/">交互体验</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术讨论/">技术讨论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/科普向/">科普向</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/视觉设计/">视觉设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/视频/">视频</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/音视频/">音视频</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/音频/">音频</a></li></ul>

            </section>
        </aside>
    </div>
</body>

</html>